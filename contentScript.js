(()=>{if(window.__gyh)return;window.__gyh={active:false};const state=window.__gyh;let overlay,info,hexEl,rgbEl,hslEl,timeEl,swatch,cv,ctx,offcv,offctx,timer,start,help,settings,historyBar;let bgColor=null;let history=[];let favs={};let opts={showMag:true,defCopy:"hex",maxHistory:12,showHsl:true};let lastColor={r:0,g:0,b:0,hx:"#000000"};function fmtHex(r,g,b){const h=n=>n.toString(16).padStart(2,"0");return"#"+h(r)+h(g)+h(b);}function fmtRgb(r,g,b){return r+","+g+","+b;}function rgb2hsl(r,g,b){r/=255;g/=255;b/=255;const max=Math.max(r,g,b),min=Math.min(r,g,b);let h,s,l=(max+min)/2;if(max===min){h=0;s=0;}else{const d=max-min;s=l>0.5?d/(2-max-min):d/(max+min);switch(max){case r:h=(g-b)/d+(g<b?6:0);break;case g:h=(b-r)/d+2;break;case b:h=(r-g)/d+4;break;}h/=6;}return{h:Math.round(h*360),s:Math.round(s*100),l:Math.round(l*100)};}function fmtHsl(r,g,b){const o=rgb2hsl(r,g,b);return o.h+","+o.s+"%,"+o.l+"%";}function luminance(r,g,b){const a=[r,g,b].map(v=>{v/=255;return v<=0.03928?v/12.92:Math.pow((v+0.055)/1.055,2.4);});return 0.2126*a[0]+0.7152*a[1]+0.0722*a[2];}function contrastRatio(c1,c2){const L1=luminance(c1.r,c1.g,c1.b);const L2=luminance(c2.r,c2.g,c2.b);const a=Math.max(L1,L2),b=Math.min(L1,L2);return(a+0.05)/(b+0.05);}function loadStore(){return new Promise(r=>chrome.storage?.local.get(["gyh_history","gyh_favs","gyh_opts"],d=>{history=d.gyh_history||[];favs=d.gyh_favs||{};opts=Object.assign(opts,d.gyh_opts||{});r();}));}function saveStore(){chrome.storage?.local.set({gyh_history:history.slice(0,opts.maxHistory),gyh_favs:favs,gyh_opts:opts});}function copy(t){try{navigator.clipboard.writeText(t);}catch(e){const a=document.createElement("textarea");a.value=t;document.body.appendChild(a);a.select();document.execCommand("copy");a.remove();}}function buildHelp(){help=document.createElement("div");help.style.cssText="position:fixed;right:10px;top:10px;background:rgba(0,0,0,.8);color:#fff;padding:8px 10px;border-radius:6px;font:12px/1.3 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial,sans-serif;max-width:320px;box-shadow:0 2px 8px rgba(0,0,0,.4);display:none;z-index:2147483647";help.innerHTML="<b>GetYourHex</b><br>Esc: exit · h/r/l: copy hex/rgb/hsl · s: save · f: cycle · b: set bg · B: clear bg · e: EyeDropper · o: settings · ?: help";overlay.appendChild(help);}function buildSettings(){settings=document.createElement("div");settings.style.cssText="position:fixed;right:10px;bottom:10px;background:rgba(0,0,0,.8);color:#fff;padding:8px 10px;border-radius:6px;font:12px/1.3 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial,sans-serif;min-width:220px;box-shadow:0 2px 8px rgba(0,0,0,.4);display:none;z-index:2147483647";settings.innerHTML="<div style='font-weight:700;margin-bottom:6px'>Settings</div>"+"<label style='display:flex;align-items:center;gap:6px;margin:4px 0'><input id='gyh_mag' type='checkbox'> Magnifier</label>"+"<label style='display:flex;align-items:center;gap:6px;margin:4px 0'>Default copy: <select id='gyh_fmt'><option value='hex'>HEX</option><option value='rgb'>RGB</option><option value='hsl'>HSL</option></select></label>"+"<label style='display:flex;align-items:center;gap:6px;margin:4px 0'>History size: <input id='gyh_hist' type='number' min='3' max='30' style='width:56px'></label>"+"<div style='opacity:.8;margin-top:6px'>Press o to close</div>";overlay.appendChild(settings);}function syncSettingsUI(){if(!settings)return;settings.querySelector('#gyh_mag').checked=!!opts.showMag;settings.querySelector('#gyh_fmt').value=opts.defCopy;settings.querySelector('#gyh_hist').value=opts.maxHistory;settings.querySelector('#gyh_mag').onchange=e=>{opts.showMag=e.target.checked;saveStore();};settings.querySelector('#gyh_fmt').onchange=e=>{opts.defCopy=e.target.value;saveStore();};settings.querySelector('#gyh_hist').oninput=e=>{opts.maxHistory=Math.max(3,Math.min(30,parseInt(e.target.value||12)));saveStore();renderHistory();};}function updateTime(){const e=Date.now()-start;const s=Math.floor(e/1000);const m=Math.floor(s/60);const ss=("0"+(s%60)).slice(-2);timeEl.textContent="t:"+m+":"+ss;}async function startPick(){if(state.active)return;state.active=true;await loadStore();const res=await new Promise(r=>chrome.runtime.sendMessage({t:"CAPTURE"},r));if(!res||!res.ok){state.active=false;return;}const img=new Image;img.onload=()=>{offcv=document.createElement("canvas");offcv.width=img.width;offcv.height=img.height;offctx=offcv.getContext("2d");offctx.drawImage(img,0,0);overlay=document.createElement("div");overlay.style.cssText="position:fixed;inset:0;z-index:2147483647;cursor:none";cv=document.createElement("canvas");cv.style.cssText="width:100vw;height:100vh;display:block";cv.width=window.innerWidth;cv.height=window.innerHeight;ctx=cv.getContext("2d");ctx.clearRect(0,0,cv.width,cv.height);ctx.drawImage(img,0,0,cv.width,cv.height);overlay.appendChild(cv);info=document.createElement("div");info.style.cssText="position:fixed;padding:6px 8px;background:rgba(0,0,0,.7);color:#fff;font:12px/1.2 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial,sans-serif;border-radius:6px;pointer-events:auto;display:flex;align-items:center;gap:8px;box-shadow:0 2px 8px rgba(0,0,0,.4)";swatch=document.createElement("div");swatch.style.cssText="width:16px;height:16px;border-radius:3px;border:1px solid rgba(255,255,255,.4)";hexEl=document.createElement("span");hexEl.style.cssText="cursor:pointer";rgbEl=document.createElement("span");rgbEl.style.cssText="cursor:pointer;margin-left:6px";hslEl=document.createElement("span");hslEl.style.cssText="cursor:pointer;margin-left:6px";timeEl=document.createElement("span");timeEl.style.cssText="opacity:.8;margin-left:6px";const ctr=document.createElement("span");ctr.style.cssText="opacity:.9;margin-left:6px";ctr.title="contrast vs bg";const close=document.createElement("button");close.textContent="×";close.style.cssText="margin-left:6px;cursor:pointer;border:0;background:#fff;color:#000;border-radius:3px;width:18px;height:18px;line-height:18px;padding:0;font-weight:700";close.addEventListener("click",stop);hexEl.addEventListener("click",()=>copy(hexEl.textContent.replace("HEX:","")));rgbEl.addEventListener("click",()=>copy(rgbEl.textContent.replace("RGB:","")));hslEl.addEventListener("click",()=>copy(hslEl.textContent.replace("HSL:","")));info.appendChild(swatch);info.appendChild(hexEl);info.appendChild(rgbEl);info.appendChild(hslEl);info.appendChild(ctr);info.appendChild(timeEl);info.appendChild(close);overlay.appendChild(info);historyBar=document.createElement("div");historyBar.style.cssText="position:fixed;right:10px;bottom:10px;display:flex;flex-wrap:wrap;gap:6px;max-width:50vw";overlay.appendChild(historyBar);renderHistory();document.documentElement.appendChild(overlay);buildHelp();buildSettings();syncSettingsUI();start=Date.now();timer=setInterval(updateTime,500);updateTime();window.addEventListener("mousemove",onMove,true);window.addEventListener("keydown",onKey,true);window.addEventListener("resize",onResize,true);};img.src=res.url;}function onResize(){if(!cv||!offcv)return;cv.width=window.innerWidth;cv.height=window.innerHeight;ctx.clearRect(0,0,cv.width,cv.height);ctx.drawImage(offcv,0,0,cv.width,cv.height);}function pickAt(x,y){if(!offcv)return{r:0,g:0,b:0};const sx=Math.min(offcv.width-1,Math.max(0,Math.floor(x*offcv.width/window.innerWidth)));const sy=Math.min(offcv.height-1,Math.max(0,Math.floor(y*offcv.height/window.innerHeight)));const d=offctx.getImageData(sx,sy,1,1).data;return{r:d[0],g:d[1],b:d[2]};}function onMove(e){const c=pickAt(e.clientX,e.clientY);const hx=fmtHex(c.r,c.g,c.b);lastColor={r:c.r,g:c.g,b:c.b,hx};hexEl.textContent="HEX:"+hx;rgbEl.textContent="RGB:"+fmtRgb(c.r,c.g,c.b);hslEl.textContent="HSL:"+fmtHsl(c.r,c.g,c.b);swatch.style.background=hx;let ix=e.clientX+16,iy=e.clientY+16;const w=260,h=28;ix=Math.min(window.innerWidth-w-10,ix);iy=Math.min(window.innerHeight-h-10,iy);info.style.left=ix+"px";info.style.top=iy+"px";drawOverlay(e.clientX,e.clientY,hx,c);updateContrast();}function drawOverlay(x,y,hx,c){ctx.clearRect(0,0,cv.width,cv.height);ctx.drawImage(offcv,0,0,cv.width,cv.height);drawCrosshair(x,y,hx);if(opts.showMag)drawMagnifier(x,y);}function drawCrosshair(x,y,hx){ctx.strokeStyle=hx;ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(x-10,y);ctx.lineTo(x+10,y);ctx.moveTo(x,y-10);ctx.lineTo(x,y+10);ctx.stroke();}function drawMagnifier(x,y){const scale=10,size=11;const half=(size-1)/2;const sx=Math.min(offcv.width-1,Math.max(half,Math.floor(x*offcv.width/window.innerWidth)));const sy=Math.min(offcv.height-1,Math.max(half,Math.floor(y*offcv.height/window.innerHeight)));const box=document.createElement("canvas");box.width=size;box.height=size;const bctx=box.getContext("2d");bctx.drawImage(offcv,sx-half,sy-half,size,size,0,0,size,size);const px=size*scale,py=px;const gx=Math.min(window.innerWidth-px-10,x+20),gy=Math.min(window.innerHeight-py-10,y+20);ctx.imageSmoothingEnabled=false;ctx.drawImage(box,0,0,size,size,gx,gy,px,py);ctx.strokeStyle="rgba(0,0,0,.6)";ctx.strokeRect(gx-1,gy-1,px+2,py+2);ctx.strokeStyle="rgba(255,255,255,.6)";ctx.strokeRect(gx-2,gy-2,px+4,py+4);const cx=gx+half*scale,cy=gy+half*scale;ctx.strokeStyle="#000";ctx.strokeRect(cx,cy,scale,scale);ctx.strokeStyle="#fff";ctx.strokeRect(cx+1,cy+1,scale-2,scale-2);}function pushHistory(c){const item={hx:c.hx,r:c.r,g:c.g,b:c.b,ts:Date.now()};history=[item,...history.filter(x=>x.hx!==c.hx)];if(history.length>opts.maxHistory)history.length=opts.maxHistory;saveStore();renderHistory();}function renderHistory(){if(!historyBar)return;historyBar.innerHTML="";history.forEach(it=>{const d=document.createElement("div");d.style.cssText="width:22px;height:22px;border-radius:4px;border:1px solid rgba(255,255,255,.5);position:relative;cursor:pointer";d.title=it.hx+" (click copy, alt+click del)";d.style.background=it.hx;d.onclick=e=>{if(e.altKey){history=history.filter(h=>h.hx!==it.hx);saveStore();renderHistory();return;}copy(it.hx);};if(favs[it.hx]){const s=document.createElement("div");s.textContent="★";s.style.cssText="position:absolute;left:2px;top:-4px;font-size:12px;color:#fff;text-shadow:0 1px 2px rgba(0,0,0,.5)";d.appendChild(s);}d.oncontextmenu=e=>{e.preventDefault();favs[it.hx]=!favs[it.hx];saveStore();renderHistory();};historyBar.appendChild(d);});}function updateContrast(){const ctr=info.children[4];if(!bgColor){ctr.textContent="";return;}const ratio=contrastRatio(bgColor,lastColor);const r=ratio.toFixed(2);let badge="";const passAA=ratio>=4.5,passAAA=ratio>=7;badge=passAAA?"AAA":passAA?"AA":"";ctr.textContent=badge?"CR:"+r+" "+badge:"CR:"+r;}async function useEyeDropper(){try{if(!window.EyeDropper)return false;const ed=new EyeDropper();const {sRGBHex}=await ed.open();const hx=sRGBHex.toLowerCase();const r=parseInt(hx.slice(1,3),16),g=parseInt(hx.slice(3,5),16),b=parseInt(hx.slice(5,7),16);lastColor={r,g,b,hx};hexEl.textContent="HEX:"+hx;rgbEl.textContent="RGB:"+fmtRgb(r,g,b);hslEl.textContent="HSL:"+fmtHsl(r,g,b);swatch.style.background=hx;pushHistory(lastColor);copyByDefault();return true;}catch(e){return false;}}function copyByDefault(){if(opts.defCopy==="hex")copy(lastColor.hx);else if(opts.defCopy==="rgb")copy(fmtRgb(lastColor.r,lastColor.g,lastColor.b));else copy(fmtHsl(lastColor.r,lastColor.g,lastColor.b));}function onKey(e){if(e.key==="Escape"){stop();return;}const k=e.key.toLowerCase();if(k==="h")copy(hexEl.textContent.replace("HEX:",""));if(k==="r")copy(rgbEl.textContent.replace("RGB:",""));if(k==="l")copy(hslEl.textContent.replace("HSL:",""));if(k==="s"){pushHistory(lastColor);}if(k==="e"){useEyeDropper();}if(k==="f"){if(opts.defCopy==="hex")opts.defCopy="rgb";else if(opts.defCopy==="rgb")opts.defCopy="hsl";else opts.defCopy="hex";saveStore();}if(k==="b"){bgColor={r:lastColor.r,g:lastColor.g,b:lastColor.b};}if(e.key==="B"){bgColor=null;}if(k==="o"){if(settings){settings.style.display=settings.style.display==="none"?"block":"none";syncSettingsUI();}}if(e.key==="?"||k==="/"){if(help)help.style.display=help.style.display==="none"?"block":"none";}updateContrast();}function stop(){state.active=false;window.removeEventListener("mousemove",onMove,true);window.removeEventListener("keydown",onKey,true);window.removeEventListener("resize",onResize,true);if(timer)clearInterval(timer);if(overlay)overlay.remove();overlay=null;info=null;hexEl=null;rgbEl=null;hslEl=null;timeEl=null;swatch=null;cv=null;ctx=null;offcv=null;offctx=null;historyBar=null;help=null;settings=null;start=0;}chrome.runtime.onMessage.addListener(m=>{if(m&&m.t==="TOGGLE"){if(state.active)stop();else startPick();}});})();
